# Apache VirtualHost for panel.velvacloud.com
# Requires modules:
#   a2enmod proxy proxy_http ssl headers rewrite headers
# Place this file at: /etc/apache2/sites-available/panel.velvacloud.com.conf
# Then run:
#   a2ensite panel.velvacloud.com
#   systemctl reload apache2

# HTTP - redirect to HTTPS
<VirtualHost *:80>
  ServerName panel.velvacloud.com

  RewriteEngine On
  RewriteRule ^/(.*)$ https://panel.velvacloud.com/$1 [R=301,L]
</VirtualHost>

# HTTPS
<VirtualHost *:443>
  ServerName panel.velvacloud.com

  # SSL certs (update paths if using certbot/letsencrypt)
  SSLEngine on
  SSLCertificateFile /etc/letsencrypt/live/panel.velvacloud.com/fullchain.pem
  SSLCertificateKeyFile /etc/letsencrypt/live/panel.velvacloud.com/privkey.pem

  # Security headers (basic hardening)
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set X-XSS-Protection "1; mode=block"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  # HSTS (enable after confirming HTTPS works, optional)
  # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

  # Preserve original host and protocol to the app
  ProxyPreserveHost On
  RequestHeader set X-Forwarded-Proto "https"
  RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s

  # Increase proxy timeouts for long-running requests if needed
  ProxyTimeout 60

  # API - proxy /api to backend (Docker mapped port 4000)
  # Important: keep the /api prefix when proxying to match Nest globalPrefix('api')
  ProxyPass        /api/ http://127.0.0.1:4000/api/
  ProxyPassReverse /api/ http://127.0.0.1:4000/api/

  # TEMP: Prisma Studio (ONLY enable while in use)
  # Start it with: docker compose exec backend npx prisma studio --host 0.0.0.0 --port 5555
  # Optional BasicAuth (uncomment and set credentials)
  # <Location /studio/>
  #   AuthType Basic
  #   AuthName "Restricted"
  #   AuthUserFile /etc/apache2/.htpasswd
  #   Require valid-user
  # </Location>
  ProxyPass        /studio/ http://127.0.0.1:5555/
  ProxyPassReverse /studio/ http://127.0.0.1:5555/

  # Frontend - everything else to Next.js (Docker mapped port 3000)
  ProxyPass        / http://127.0.0.1:3000/
  ProxyPassReverse / http://127.0.0.1:3000/

  # Optional: gzip - ensure deflate module enabled if using this
  # SetOutputFilter DEFLATE

  ErrorLog  ${APACHE_LOG_DIR}/panel.velvacloud.com_error.log
  CustomLog ${APACHE_LOG_DIR}/panel.velvacloud.com_access.log combined
</VirtualHost>